<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>supervisor documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	   <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/dark.css">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top visible-xs">
            <a href="../" class="navbar-brand">supervisor documentation</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content injectable">
                   <div class="content-data">








<ol class="breadcrumb">
  <li>Injectables</li>
  <li >RecordsService</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="active">
            <a href="#info" role="tab" id="info-tab" data-toggle="tab" data-link="info">Info</a>
        </li>
        <li >
            <a href="#source" role="tab" id="source-tab" data-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="c-info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/records/records.service.ts</code>
        </p>





            <section>
    <h3 id="index">Index</h3>
    <table class="table table-sm table-bordered index-table">
        <tbody>
                <tr>
                    <td class="col-md-4">
                        <h6><b>Properties</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                <a href="#recordFluentTrancriptionSeq" >recordFluentTrancriptionSeq</a>
                            </li>
                        </ul>
                    </td>
                </tr>

                <tr>
                    <td class="col-md-4">
                        <h6><b>Methods</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#appendRecord" >appendRecord</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#createRecord" >createRecord</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#findByFilters" >findByFilters</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#findRecordById" >findRecordById</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getExistingRecord" >getExistingRecord</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#stopRecord" >stopRecord</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#transcriptRecord" >transcriptRecord</a>
                            </li>
                        </ul>
                    </td>
                </tr>





        </tbody>
    </table>
</section>

            <section>
    <h3 id="constructor">Constructor</h3>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
<code>constructor(recordModel, transcriptionModel, callsService: <a href="../injectables/CallsService.html" target="_self">CallsService</a>, srService: <a href="../injectables/SRService.html" target="_self">SRService</a>, sequelize: Sequelize)</code>
                    </td>
                </tr>
                        <tr>
                            <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="101" class="link-to-prism">src/records/records.service.ts:101</a></div>
                            </td>
                        </tr>

                <tr>
                    <td class="col-md-4">
                            <div>
                                    <b>Parameters :</b>
                                    <table class="params">
                                        <thead>
                                            <tr>
                                                <td>Name</td>
                                                    <td>Type</td>
                                                <td>Optional</td>
                                            </tr>
                                        </thead>
                                        <tbody>
                                                <tr>
                                                        <td>recordModel</td>
                                                  
                                                        <td>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>transcriptionModel</td>
                                                  
                                                        <td>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>callsService</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/CallsService.html" target="_self" >CallsService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>srService</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/SRService.html" target="_self" >SRService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>sequelize</td>
                                                  
                                                        <td>
                                                                    <code>Sequelize</code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                        </tbody>
                                    </table>
                            </div>
                    </td>
                </tr>
            </tbody>
        </table>
</section>

            <section>
    
    <h3 id="methods">
        Methods
    </h3>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="appendRecord"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>appendRecord</b></span>
                        <a href="#appendRecord"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>appendRecord(payload: WithUser<AppendRecordPayload>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="221"
                            class="link-to-prism">src/records/records.service.ts:221</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>payload</td>
                                    <td>
                                            <code>WithUser&lt;AppendRecordPayload&gt;</code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;void&gt;</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="createRecord"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>createRecord</b></span>
                        <a href="#createRecord"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>createRecord(payload: WithUser<CallIDPayload>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="156"
                            class="link-to-prism">src/records/records.service.ts:156</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>payload</td>
                                    <td>
                                            <code>WithUser&lt;CallIDPayload&gt;</code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="../classes/Record.html" target="_self" >Promise&lt;RecordType | null&gt;</a></code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="findByFilters"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>findByFilters</b></span>
                        <a href="#findByFilters"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>findByFilters(payload: <a href="../classes/Record.html" target="_self">RecordFilters</a>, includeMode: <a href="../classes/Record.html" target="_self">RecordIncluders</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="122"
                            class="link-to-prism">src/records/records.service.ts:122</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>payload</td>
                                    <td>
                                                <code><a href="../classes/Record.html" target="_self" >RecordFilters</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>includeMode</td>
                                    <td>
                                                <code><a href="../classes/Record.html" target="_self" >RecordIncluders</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="../classes/Record.html" target="_self" >Promise&lt;FilteredRecords&gt;</a></code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="findRecordById"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>findRecordById</b></span>
                        <a href="#findRecordById"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>findRecordById(id: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank">number</a>, mode?: <a href="../classes/Record.html" target="_self">RecordIncluders</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="112"
                            class="link-to-prism">src/records/records.service.ts:112</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>id</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>mode</td>
                                    <td>
                                                <code><a href="../classes/Record.html" target="_self" >RecordIncluders</a></code>
                                    </td>

                                    <td>
                                        Yes
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="../classes/Record.html" target="_self" >Promise&lt;RecordType | null&gt;</a></code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getExistingRecord"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>getExistingRecord</b></span>
                        <a href="#getExistingRecord"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getExistingRecord(callId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank">number</a>, userId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank">number</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="190"
                            class="link-to-prism">src/records/records.service.ts:190</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>callId</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>userId</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;literal type&gt;</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="stopRecord"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>stopRecord</b></span>
                        <a href="#stopRecord"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>stopRecord(payload: WithUser<CallIDPayload>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="249"
                            class="link-to-prism">src/records/records.service.ts:249</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>payload</td>
                                    <td>
                                            <code>WithUser&lt;CallIDPayload&gt;</code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;void&gt;</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="transcriptRecord"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>transcriptRecord</b></span>
                        <a href="#transcriptRecord"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>transcriptRecord(recordId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank">number</a>, mode: <a href="../undefineds/SRMode.html" target="_self">SRMode</a>, side: <a href="../classes/Call.html" target="_self">CallSide</a>, src: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="347"
                            class="link-to-prism">src/records/records.service.ts:347</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>recordId</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>mode</td>
                                    <td>
                                                <code><a href="../miscellaneous/enumerations.html#SRMode" target="_self" >SRMode</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>side</td>
                                    <td>
                                                <code><a href="../classes/Call.html" target="_self" >CallSide</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>src</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</section>
            <section>
    
    <h3 id="inputs">
        Properties
    </h3>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="recordFluentTrancriptionSeq"></a>
                    <span class="name">
                        <span ><b>recordFluentTrancriptionSeq</b></span>
                        <a href="#recordFluentTrancriptionSeq"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>        <code><a href="../classes/Record.html" target="_self" >RecordFluentTrancriptionSeq</a></code>

                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Default value : </i><code>{}</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="101" class="link-to-prism">src/records/records.service.ts:101</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
</section>

    </div>


    <div class="tab-pane fade  tab-source-code" id="c-source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { Injectable } from &#x27;@nestjs/common&#x27;;
import { InjectModel } from &#x27;@nestjs/sequelize&#x27;;
import { Sequelize } from &#x27;sequelize-typescript&#x27;;
import { CallIDPayload } from &#x27;src/webrtc/types&#x27;;
import { WsException } from &#x27;@nestjs/websockets&#x27;;
import { WithUser } from &#x27;src/auth/types&#x27;;
import { CallsService } from &#x27;src/calls/calls.service&#x27;;
import {
  AppendRecordPayload,
  FilteredRecords,
  RecordErrors,
  RecordFilters,
  RecordFluentTrancriptionSeq,
  RecordIncluders,
  RecordType,
} from &#x27;./types&#x27;;
import { Record as RecordModel } from &#x27;./records.model&#x27;;
import { Call as CallModel } from &#x27;src/calls/calls.model&#x27;;
import * as path from &#x27;path&#x27;;
import * as ffmpeg from &#x27;fluent-ffmpeg&#x27;;
import {
  CHUNK_DURATION,
  PROCESS_TOTAL_OFFSET,
  RECORDS_FILE_PATH,
  TARGET_EXT,
} from &#x27;./constants&#x27;;
import { extension } from &#x27;mime-types&#x27;;
import promisify &#x3D; require(&#x27;promisify-node&#x27;);
import {
  buildAppenderSideName,
  buildTranscriptionForeignId,
  getCallSideChunkNames,
  getDuration,
} from &#x27;./helpers&#x27;;
import { last, takeWhile } from &#x27;lodash&#x27;;
import { CallSide, CallStatus, CallType } from &#x27;src/calls/types&#x27;;
import { SRService } from &#x27;src/SpeechRecognition/sr.service&#x27;;
import { nanoid } from &#x27;nanoid&#x27;;
import { SRMode, TranscriptionUnit } from &#x27;src/SpeechRecognition/types&#x27;;
import { Transcription as TranscriptionModel } from &#x27;./transcription.model&#x27;;
import { consoleBlue } from &#x27;helpers/coloredConsole&#x27;;
import { Readable } from &#x27;stream&#x27;;
import { existsSync } from &#x27;fs&#x27;;
import { Where } from &#x27;sequelize/types/utils&#x27;;
import { Op } from &#x27;sequelize&#x27;;
import { User as UserModel } from &#x27;src/users/users.model&#x27;;

const promisedFs &#x3D; promisify(&#x27;fs&#x27;);

const includers &#x3D; (mode: RecordIncluders) &#x3D;&gt; {
  const res &#x3D; [
    {
      model: CallModel,
      as: &#x27;call&#x27;,
      include: [
        {
          model: UserModel,
          as: &#x27;caller&#x27;,
        },
        {
          model: UserModel,
          as: &#x27;callee&#x27;,
        },
      ],
    },
  ] as any;

  if (mode &#x3D;&#x3D;&#x3D; RecordIncluders.base) return res;

  if ([RecordIncluders.deep, RecordIncluders.all].includes(mode)) {
    res.push(
      {
        model: TranscriptionModel,
        as: &#x27;transcriptionCaller&#x27;,
      },
      {
        model: TranscriptionModel,
        as: &#x27;transcriptionCallee&#x27;,
      },
    );
  }

  if ([RecordIncluders.fluent, RecordIncluders.all].includes(mode)) {
    res.push(
      {
        model: TranscriptionModel,
        as: &#x27;transcriptionCallerFluent&#x27;,
      },
      {
        model: TranscriptionModel,
        as: &#x27;transcriptionCalleeFluent&#x27;,
      },
    );
  }

  return res;
};

@Injectable()
export class RecordsService {
  recordFluentTrancriptionSeq: RecordFluentTrancriptionSeq &#x3D; {};
  constructor(
    @InjectModel(RecordModel)
    private recordModel: typeof RecordModel,
    @InjectModel(TranscriptionModel)
    private transcriptionModel: typeof TranscriptionModel,
    private callsService: CallsService,
    private srService: SRService,
    private sequelize: Sequelize,
  ) {}

  async findRecordById(
    id: number,
    mode?: RecordIncluders,
  ): Promise&lt;RecordType | null&gt; {
    console.log(id);
    return await this.recordModel.findByPk(id, {
      include: includers(mode || RecordIncluders.base),
    });
  }

  async findByFilters(
    payload: RecordFilters,
    includeMode: RecordIncluders,
  ): Promise&lt;FilteredRecords&gt; {
    const where &#x3D; {
      &#x27;$call.callerId$&#x27;: payload.callersList
        ? { [Op.in]: payload.callersList }
        : undefined,
      &#x27;$call.calleeId$&#x27;: payload.calleesList
        ? { [Op.in]: payload.calleesList }
        : undefined,
      &#x27;$call.status$&#x27;: { [Op.in]: payload.status },
      duration: {
        [Op.between]: [payload.duration.from, payload.duration.to],
      },
    };

    const total &#x3D; await this.recordModel.count({
      where,
      include: includers(includeMode),
    });

    const records &#x3D; await this.recordModel.findAll({
      where,
      limit: payload.limit ? Number(payload.limit) : undefined,
      offset: payload.page
        ? (Number(payload.page) - 1) * Number(payload.limit)
        : undefined,
      include: includers(includeMode),
    });

    return { total, records };
  }

  async createRecord(
    payload: WithUser&lt;CallIDPayload&gt;,
  ): Promise&lt;RecordType | null&gt; {
    const call &#x3D; await this.callsService.findCallById(payload.callId);

    if (!call) {
      throw new WsException(RecordErrors.WrongCallToAttach);
    }

    if (call.recordId) {
      throw new WsException(RecordErrors.RecordExist);
    }

    let record &#x3D; null;
    await this.sequelize.transaction(async (t) &#x3D;&gt; {
      record &#x3D; await this.recordModel.create(
        {
          callId: call.id,
        },
        { transaction: t },
      );

      if (record) {
        await this.callsService.addRecord(record.id, call.id);

        const srcDirPath &#x3D; path.resolve(RECORDS_FILE_PATH, String(record.id));

        await promisedFs.mkdir(srcDirPath);
      }
    });

    return await this.findRecordById(record.id);
  }

  async getExistingRecord(
    callId: number,
    userId: number,
  ): Promise&lt;{
    call: CallType;
    record: RecordType;
    recordPath: string;
    side: CallSide;
  }&gt; {
    const call &#x3D; await this.callsService.findCallById(callId);

    if (!call) {
      throw new WsException(RecordErrors.WrongCallToAttach);
    }

    const side &#x3D; userId &#x3D;&#x3D;&#x3D; call.callerId ? CallSide.Caller : CallSide.Callee;

    const record &#x3D; await this.findRecordById(call.recordId);

    const recordPath &#x3D; record?.id
      ? path.resolve(RECORDS_FILE_PATH, String(record.id))
      : &#x27;&#x27;;

    return {
      recordPath,
      call,
      record,
      side,
    };
  }

  async appendRecord(payload: WithUser&lt;AppendRecordPayload&gt;): Promise&lt;void&gt; {
    const { recordPath, record, side } &#x3D; await this.getExistingRecord(
      payload.callId,
      payload.user.id,
    );

    const format &#x3D; extension(payload.format);

    if (!format || !recordPath) return;

    const sideChunks &#x3D; await getCallSideChunkNames(recordPath, side);

    const lastChunkNumber: number &#x3D; sideChunks.length
      ? parseInt(last(sideChunks))
      : 0;

    const tmpPath &#x3D; path.resolve(
      recordPath,
      &#x60;${lastChunkNumber + 1}_${buildAppenderSideName(side)}_tmp.mp3&#x60;,
    );

    ffmpeg(Readable.from(Buffer.from(new Uint8Array(payload.recordBlob)))).save(
      tmpPath,
    );

    this.transcriptRecord(record.id, SRMode.fluent, side, tmpPath);
  }

  async stopRecord(payload: WithUser&lt;CallIDPayload&gt;): Promise&lt;void&gt; {
    await new Promise((resolve) &#x3D;&gt;
      setTimeout(resolve, CHUNK_DURATION + PROCESS_TOTAL_OFFSET),
    );

    const { side, record, recordPath } &#x3D; await this.getExistingRecord(
      payload.callId,
      payload.user.id,
    );

    const targetPath &#x3D; path.resolve(
      recordPath,
      &#x60;${buildAppenderSideName(side)}.${TARGET_EXT}&#x60;,
    );

    const sideChunks &#x3D; await getCallSideChunkNames(recordPath, side);

    if (!sideChunks.length) {
      return;
    }

    await promisedFs.writeFile(targetPath, &#x27;&#x27;);

    let fn &#x3D; ffmpeg();

    sideChunks.forEach((chunk) &#x3D;&gt; {
      fn &#x3D; fn.input(path.resolve(recordPath, chunk));
    });

    await new Promise&lt;void&gt;((resolve, reject) &#x3D;&gt; {
      fn.format(TARGET_EXT)
        .mergeToFile(targetPath)
        .on(&#x27;end&#x27;, () &#x3D;&gt; {
          resolve();
        })
        .on(&#x27;error&#x27;, (e) &#x3D;&gt; {
          console.log(&#x27;mergeReject&#x27;, e);
          reject();
        });
    });

    const callerPath &#x3D; path.resolve(
      recordPath,
      &#x60;${buildAppenderSideName(CallSide.Callee)}.${TARGET_EXT}&#x60;,
    );

    const calleePath &#x3D; path.resolve(
      recordPath,
      &#x60;${buildAppenderSideName(CallSide.Caller)}.${TARGET_EXT}&#x60;,
    );

    const mergedPath &#x3D; path.resolve(recordPath, &#x60;srcMerged.${TARGET_EXT}&#x60;);
    await this.sequelize.transaction(async (t) &#x3D;&gt; {
      await this.recordModel.update(
        {
          [buildAppenderSideName(side)]: targetPath,
        },
        { transaction: t, where: { id: record.id } },
      );

      if (
        existsSync(callerPath) &amp;&amp;
        existsSync(calleePath) &amp;&amp;
        !existsSync(mergedPath)
      ) {
        await new Promise((resolve) &#x3D;&gt;
          ffmpeg()
            .input(callerPath)
            .input(calleePath)
            .complexFilter([
              {
                filter: &#x27;amix&#x27;,
                options: { inputs: 2, duration: &#x27;longest&#x27; },
              },
            ])
            .on(&#x27;end&#x27;, resolve)
            .saveToFile(mergedPath),
        );

        const duration &#x3D; await getDuration(mergedPath);

        await this.recordModel.update(
          {
            srcMerged: mergedPath,
            duration,
          },
          { transaction: t, where: { id: record.id } },
        );
      }
    });

    if (this.recordFluentTrancriptionSeq[record.id]) {
      delete this.recordFluentTrancriptionSeq[record.id];
    }

    this.transcriptRecord(record.id, SRMode.deep, side, targetPath);
  }

  async transcriptRecord(
    recordId: number,
    mode: SRMode,
    side: CallSide,
    src: string,
  ) {
    const taskId &#x3D; nanoid();

    if (mode &#x3D;&#x3D;&#x3D; SRMode.fluent) {
      if (!this.recordFluentTrancriptionSeq[recordId]) {
        this.recordFluentTrancriptionSeq[recordId] &#x3D; {};
      }

      if (!this.recordFluentTrancriptionSeq[recordId][side]) {
        this.recordFluentTrancriptionSeq[recordId][side] &#x3D; [];
      }

      this.recordFluentTrancriptionSeq[recordId][side].push({ taskId, src });
    }

    const result &#x3D; await this.srService.speechToText(src, mode, taskId);
    const record &#x3D; await this.findRecordById(recordId);

    let unitsToWrite: TranscriptionUnit[] &#x3D; [];

    if (mode &#x3D;&#x3D;&#x3D; SRMode.fluent) {
      this.recordFluentTrancriptionSeq[recordId][side] &#x3D;
        this.recordFluentTrancriptionSeq[recordId][side].map((task) &#x3D;&gt;
          task.taskId &#x3D;&#x3D;&#x3D; taskId ? { ...task, result: result.result } : task,
        );

      const tasksToWrite &#x3D; takeWhile(
        this.recordFluentTrancriptionSeq[recordId][side],
        (value) &#x3D;&gt; !!value.result,
      );

      const transcripts &#x3D;
        side &#x3D;&#x3D;&#x3D; CallSide.Callee
          ? record.transcriptionCalleeFluent
          : record.transcriptionCallerFluent;
      const lastTimestamp &#x3D; transcripts?.length ? last(transcripts).end : 0;

      for (let i &#x3D; 0; i &lt; tasksToWrite.length; i++) {
        const curTask &#x3D; tasksToWrite[i];

        const duration &#x3D; await getDuration(curTask.src);

        curTask.result.forEach((unit, inx, arr) &#x3D;&gt; {
          unitsToWrite.push({
            ...unit,
            start: Number(lastTimestamp) + Number(unit.start),
            end:
              Number(lastTimestamp) +
              Number(inx &#x3D;&#x3D;&#x3D; arr.length - 1 ? duration : unit.end),
          });
        });
      }
    } else {
      unitsToWrite &#x3D; result.result;
    }

    await this.sequelize.transaction(async (t) &#x3D;&gt; {
      await this.transcriptionModel.bulkCreate(
        unitsToWrite.map((unit) &#x3D;&gt; ({
          ...unit,
          [buildTranscriptionForeignId(side, mode)]: record.id,
        })),
        { transaction: t },
      );
    });
  }
}
</code></pre>
    </div>

</div>













                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

          <label class="dark-mode-switch">
               <input type="checkbox">
               <span class="slider">
                    <svg class="slider-icon" viewBox="0 0 24 24" fill="none" height="20" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                    </svg>
               </span>
          </label>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'injectable';
            var COMPODOC_CURRENT_PAGE_URL = 'RecordsService.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>

       <script src="../js/menu-wc.js" defer></script>
       <script nomodule src="../js/menu-wc_es5.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
